<?xml version="1.0" encoding="UTF-8"?>
<!-- Tripane Help creation.  -->
<project name="com.kpe.lms-calendar" basedir="." default="dita2lms-calendar">
    
    <property name="dita2lms-calendar.version" value="3.0.0"/>
    <property name="dita2lms-calendar.date" value="2015-04-06"/>

    <!-- Makes renaming the plugin easier. -->
    <property name="dita2lms-calendar.plugin.dir" value="${dita.plugin.com.kpe.lms-calendar.dir}"/>
    <property name="dita2lms-calendar.temp.dir" value="${dita2lms-calendar.plugin.dir}${file.separator}temp"/> <!-- not used. -->
    
    <!-- To implement the chunking, we'll probably have to implement a pre-processor to filter from the 
         args.input to the temp.dir. Then we'll process from temp to output. -->
    
    <property name="dita2lms-calendar.supermap" value="${dita2lms-calendar.plugin.dir}${file.separator}xsl${file.separator}dita2supermap.xsl"/>
    <property name="dita2lms-calendar.transform" value="${dita2lms-calendar.plugin.dir}${file.separator}xsl${file.separator}dita2lms-calendar.xsl"/>
    
    <property name="supermap.ditamap" value="supermap.ditamap"/>
    <property name="toc.ditamap" value="toc.ditamap"/>
    
    <property name="args.figurelink.style" value="TITLE"/>
    <property name="assetfile" value="assets.list"/>
    
    
<!--    <target name="preprocess" depends="gen-list,debug-filter,copy-files,
        conrefpush,conref,move-meta-entries,keyref,coderef,mapref,mappull,chunk,maplink,move-links,topicpull,flag-module" description="Preprocessing ended"></target>
-->    
    
    <target name="dita2lms-calendar"
        depends="dita2lms-calendar.announce,build-init, dita2lms-calendar.init, 
        gen-list,debug-filter,dita2lms-calendar.copy-files, 
        conrefpush,conref,move-meta-entries,keyref,coderef,mapref,mappull,chunk,maplink,move-links, topicpull,
        dita2lms-calendar.transform, 
        dita2lms-calendar.cleanup, dita2lms-calendar.debug,dita2lms-calendar.donetimedate">
    </target>
    
    <target name="dita2lms-calendar.announce">
        <echo>Running dita2lms-calendar ${dita2lms-calendar.version} (${dita2lms-calendar.date}).</echo>
    </target>
    
    <target name="dita2lms-calendar.donetimedate">
        <tstamp>
            <format property="donetimedate" pattern="yyyy-MM-dd KK:mm:ss"/>
        </tstamp>
        <echo>Finished at ${donetimedate}.</echo>
    </target>
    
    <!-- topicpull,flag-module, -->
    <target name="dita2lms-calendar.init">
        <echo>In init...</echo>
        <echo>temp dir is ${dita.temp.dir}</echo>
        
        <mkdir dir="${output.dir}${file.separator}topics"/>
        <mkdir dir="${output.dir}${file.separator}tasks"/>
        <mkdir dir="${output.dir}${file.separator}los"/>
        
    </target>
    
    <target name="dita2lms-calendar.transform">
        <!-- ${dita.temp.dir.fullpath}${file.separator}${user.input.file} -->
        <xslt processor="trax" 
            basedir="${dita.temp.dir}"
            destdir="${dita.temp.dir}" 
            force="true"
            in="${dita.temp.dir}${file.separator}${dita.input.filename}"
            out="${dita.temp.dir}${file.separator}${supermap.ditamap}"
            style="${dita2lms-calendar.supermap}"
            >
            <param name="BASE_DIR" expression="${dita.temp.dir}${file.separator}"/>
            <param name="OUT_DIR" expression="${dita.temp.dir}${file.separator}"/>
            <xmlcatalog>
                <catalogpath path="${xml.catalog.files}"/>
            </xmlcatalog>
        </xslt>
        
        <echo>
            Transforming DITA to PACE...
        </echo>
        
        <xslt processor="trax" 
            basedir="${dita.temp.dir}"
            destdir="${output.dir}" 
            force="true"
            in="${dita.temp.dir}${file.separator}${supermap.ditamap}"
            out="${output.dir}${file.separator}${toc.ditamap}"
            style="${dita2lms-calendar.transform}"
            >
            <param name="BASE_DIR" expression="${dita.temp.dir}${file.separator}"/>
            <param name="OUT_DIR" expression="${output.dir}"/>
            <xmlcatalog>
                <catalogpath path="${xml.catalog.files}"/>
            </xmlcatalog>
        </xslt>
        
        
    </target>
    
    <!-- Overridden from build_preprocess to amend copy-image (and delete copy-html. -->
    <target name="dita2lms-calendar.copy-files" 
        depends="dita2lms-calendar.copy-image,copy-flag,copy-subsidiary,copy-generated-files" 
        unless="preprocess.copy-files.skip"></target>
    
    <target name="dita2lms-calendar.copy-image-uplevels" if="image.copy.uplevels" depends="copy-image-check" unless="preprocess.copy-image.skip" description="Copy image files">
        <copy todir="${output.dir}/${uplevels}/assets" flatten="true">
            <fileset dir="${user.input.dir}" includesfile="${dita.temp.dir}/${d_imagefile}"></fileset>
        </copy>
    </target>
    
    <target name="dita2lms-calendar.copy-image-normal" if="image.copy.normal" depends="copy-image-check" unless="preprocess.copy-image.skip" description="Copy image files">
        <copy todir="${output.dir}/assets" flatten="true">
            <fileset dir="${user.input.dir}" includesfile="${dita.temp.dir}/${d_imagefile}"></fileset>
        </copy>
    </target>
    
    <target name="dita2lms-calendar.copy-image" depends="dita2lms-calendar.copy-image-uplevels,dita2lms-calendar.copy-image-normal" description="Copy image files">   
    </target>
    
    <target name="copy-image-check">
        <condition property="preprocess.copy-image.skip">
            <or>
                <isset property="preprocess.copy-files.skip"></isset>
                <isset property="noImagelist"></isset>
            </or>
        </condition>
        <condition property="image.copy.uplevels">
            <not>
                <equals arg1="${generate.copy.outer}" arg2="3"></equals>
            </not>
        </condition>
        <condition property="image.copy.normal">
            <and>
                <equals arg1="${generate.copy.outer}" arg2="3"></equals>
            </and>
        </condition> 	
        
        <property name="d_imagefile" value="digital_images.list"></property>
        <copy file="${dita.temp.dir}/${imagefile}" tofile="${dita.temp.dir}/${d_imagefile}">
            <filterchain>
                <linecontains>
                    <contains value="/digital/"/>
                </linecontains>
            </filterchain>
        </copy>
        
    </target>
    
    
    <target name="dita2lms-calendar.findassets">
        
        <!-- filter html.list to exclude entries with a web-address. -->
        <copy file="${dita.temp.dir}/${htmlfile}" tofile="${dita.temp.dir}/${assetfile}">
            <filterchain>
                <linecontains negate="true">
                    <contains value="http"/>
                </linecontains>
            </filterchain>
        </copy>

        <condition property="got.assets" value="true">
            <length file="${dita.temp.dir}/${assetfile}" when="greater" length="0"/>
        </condition>
        
        <echo>got.assets is ${got.assets}.</echo>
        
        <!-- Look for a glossary. -->
        <condition property="got.glossary">
            <available file="${dita.temp.dir}${file.separator}glossary"/>
        </condition>    
        
        <echo>got.glossary is ${got.glossary}.</echo>
    </target>
    
    
    <target name="dita2lms-calendar.moveassets" if="got.assets">
        
        <!-- [SP] 2015-01-27: NOTES:
            There are currently two issues:
            * The standard OT processing copies images from the input folder to the output folder, along 
              with their entire structure, so if the images are in course_samples/assets/digital, that entire 
              directory tree gets copied to the output folder.  (What we want in PACE is for all assets to 
              be copied to a single assets folder.)
            * There are other resources, in addition to images (SWF and PDF), that need to be moved 
              to the assets folder from the input folder. The OT detects SWFs and lists them in a 
              couple of .list files, but is entirely ignorant of the PDFs. 
        
        -->
        
        <echo>In cleanup...</echo>
        
        <!-- The assets folder is created in the wrong folder (one level down); it needs to be moved to the output directory. -->
        <echo>Moving assets folder:</echo>
        

        <!-- copy those files to the assets folder, with flatten="true".-->
        <copy todir="${output.dir}/assets" flatten="true">
            <fileset dir="${user.input.dir}" includesfile="${dita.temp.dir}/${assetfile}"></fileset>
        </copy>
        
    </target>
    
    <target name="dita2lms-calendar.moveglossary" if="got.glossary">
        <property name="dita2lms-calendar.glossary.dir" value="${dita.temp.dir}${file.separator}glossary"/>
        <property name="dita2lms-calendar.glossary.xsl" value="${dita2lms-calendar.plugin.dir}${file.separator}xsl${file.separator}glossary2pace.xsl"/>
        
<!--        <copy todir="${output.dir}${file.separator}glossary">
            <fileset dir="${dita2lms-calendar.glossary.dir}"/>
            <flattenmapper/>
        </copy>
-->        
        <xslt basedir="${dita2lms-calendar.glossary.dir}" 
            destdir="${output.dir}${file.separator}glossary" 
            style="${dita2lms-calendar.glossary.xsl}">
            <flattenmapper/>            
        </xslt>
        
    </target>
    
    <target name="dita2lms-calendar.cleanup" depends="dita2lms-calendar.findassets,dita2lms-calendar.moveassets,dita2lms-calendar.moveglossary">
        
        <mkdir dir="${output.dir}/ASCII"/>
        
        <echo>Applying native2ascii for *.dita in ${output.dir}.</echo>
        <native2ascii encoding="UTF-8" src="${output.dir}" dest="${output.dir}/ASCII"
            includes="**/*.dita" ext=".dita"/>
        <echo>Applying native2ascii for *.xml in ${output.dir}.</echo>
        <native2ascii encoding="UTF-8" src="${output.dir}" dest="${output.dir}/ASCII"
            includes="**/*.xml" ext=".xml"/>
        
        <echo>Converting \unnnn to &amp;nnnn;.</echo>
        <replaceregexp 
            encoding="utf-8"
            match='\\u(....)'
            replace='&amp;#x\1;'
            flags="g">
            <fileset dir="${output.dir}/ASCII">
                <include name="**/*.dita"/>
                <include name="**/*.xml"/>
            </fileset>
        </replaceregexp>
<!--        <replaceregexp 
            encoding="utf-8"
            match='\\u(....)'
            replace='&amp;#x\1;'>
        </replaceregexp>
-->
        <echo>Converting &amp;amp; to &amp;#038;.</echo>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='&amp;amp;'
            value='&amp;#038;' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='&amp;amp;'
            value='&amp;#038;' summary="yes">
            <include name="**/*.xml"/>
        </replace>
        <echo>Converting &amp;lt; to &amp;#060;.</echo>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='&amp;lt;'
            value='&amp;#060;' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='&amp;lt;'
            value='&amp;#060;' summary="yes">
            <include name="**/*.xml"/>
        </replace>
        <echo>Converting &amp;gt; to &amp;#062;.</echo>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='&amp;gt;'
            value='&amp;#062;' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='&amp;gt;'
            value='&amp;#062;' summary="yes">
            <include name="**/*.xml"/>
        </replace>
        
        <echo>Removing ditaarch namespace declaration.</echo>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token=' xmlns:ditaarch="http://dita.oasis-open.org/architecture/2005/"'
            value='' summary="yes">
            <include name="**/*.dita"/>
        </replace>

        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token=' xmlns:ditaarch="http://dita.oasis-open.org/architecture/2005/"'
            value='' summary="yes">
            <include name="**/*.xml"/>
        </replace>

        <echo>Removing default namespace declaration.</echo>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token=' xmlns=""'
            value='' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token=' xmlns=""'
            value='' summary="yes">
            <include name="**/*.xml"/>
        </replace>

        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='DOCTYPE kaptask'
            value='DOCTYPE topic' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='DOCTYPE kaptask'
            value='DOCTYPE topic' summary="yes">
            <include name="**/*.xml"/>
        </replace>

        <echo>Removing temp from xmlns:tempxs. </echo>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='xmlns:temp="temp'
            value='xmlns:xs="' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='xmlns:temp="temp'
            value='xmlns:xs="' summary="yes">
            <include name="**/*.xml"/>
        </replace>
        
        <!-- (R) was coming out in Hex, just in case PACE can't deal with that, replace with decimal. -->
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='#x00ae;'
            value='#174;' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='#x00ae;'
            value='#174;' summary="yes">
            <include name="**/*.xml"/>
        </replace>

        <!-- Remove the doctype from assessmentItems, questions, and question maps. -->
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='&lt;!DOCTYPE assessmentItem'
            value='' summary="yes">
            <include name="**/*.xml"/>
        </replace>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='&lt;!DOCTYPE question'
            value='' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='  PUBLIC "&apos;&apos;" "&apos;&apos;"&gt;'
            value='' summary="yes">
            <include name="**/*.xml"/>
        </replace>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='  PUBLIC "&apos;&apos;" "&apos;&apos;"&gt;'
            value='' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        
        <!-- Hyphen is behaving oddly. -->
        <echo>Converting #038;#045; to #045;.</echo>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='#038;#045;'
            value='#045;' summary="yes">
            <include name="**/*.dita"/>
        </replace>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='#038;#045;'
            value='#045;' summary="yes">
            <include name="**/*.xml"/>
        </replace>
        
<!--        replace test_topic_practice with test_practice-->
        <echo>HELLO PDITA! FIRST ONE TO SPOT THIS GETS A STICKER! :D</echo>
        <replace dir="${output.dir}/ASCII"
            encoding="utf-8"
            token='test_topic_practice'
            value='test_practice' summary="yes">
            <include name="questions/*.dita"/>
        </replace>
        
        <copy todir="${output.dir}" overwrite="true">
            <fileset dir="${output.dir}/ASCII"/>
        </copy>
        
        <delete dir="${output.dir}/ASCII"/>
        
        <echo>Deleting DITA list files</echo>
        <delete file="${output.dir}${file.separator}dita.list" failonerror="false"/>
        <delete file="${output.dir}${file.separator}dita.xml.properties" failonerror="false"/>
        
        <echo>Deleting extra MREP folder</echo>
        <delete dir="${output.dir}${file.separator}MREP" failonerror="false"/>
        
    </target>
    
    <target name="dita2lms-calendar.debug" if="lms-calendar.debug">
        <echo>lms-calendar.debug is on: copying supermap.ditamap to out folder. </echo>
        <copy file="${dita.temp.dir}${file.separator}supermap.ditamap" todir="${dita.map.output.dir}"/>
    </target>
    

</project>
