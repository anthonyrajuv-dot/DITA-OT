<?xml version="1.0" encoding="utf-8"?>
<project name="dita2sepub3">

    <antversion property="antversion"/>
    
    <property name="xml.ext" value=".xml"/>
    <property name="out.ext" value=".html"/>

    <property name="args.rellinks" value="nofamily"/>

    <!-- [SP] Force XSL to substitute .png extensions for .svg images. -->
    <property name="force.pngs" value="true"/>

    <!-- [SP] 8-Mar-2013: Ensure that xref links use the figure and table titles. -->
    <property name="args.figurelink.style" value="TITLE"/>
    <property name="args.tablelink.style" value="TITLE"/>

    <!-- copy-revflag,-->
    <target name="dita2sepub3"
        depends="sepub3.cleanup.pre, build-init, preprocess, kpe.locale.props, dita.map.xhtml,
        copy-css,  dita.topics.xhtml, sepub3.dita.inner.topics.xhtml, dita.outer.topics.xhtml,
        sepub3.nav_html, sepub3.content_opf, sepub3.index, copy.pngs, sepub3.make_dups, sepub3.make_package, sepub3.cleanup,
        sepub3.donetimedate"> </target>
    
    <target name="sepub3.donetimedate">
        <tstamp>
            <format property="donetimedate" pattern="yyyy-MM-dd HH:mm:ss"/>
        </tstamp>
        <echo>Finished at ${donetimedate} (Ant version ${antversion}).</echo>
    </target>
    

    <!-- <target name="kpe.build.xhtml"
        depends="build-init, preprocess, kpe.locale.props, dita.map.xhtml, copy-revflag, 
        copy-css, kpe.topic.list, dita.topics.xhtml, dita.inner.topics.xhtml, dita.outer.topics.xhtml"
        description="Largely stolen from dita2xhtml. Mostly there to insert kpe.topic.list, which we need sometimes to check xrefs."> -->

    <!-- [SP] add preprocessing to clean up preexisting files SSO -->
    <target name="sepub3.cleanup.pre">
        <!-- [SP] 14-Jan-13 sfb: Added quiet attribute so that the task doesn't fail if the directory doesn't exist. -->
        <delete includeemptydirs="yes" quiet="true">
            <fileset dir="${output.dir}">
                <include name="**/*"/>
            </fileset>
        </delete>
        <!-- [SP] 12-Mar-2015 sfb: Added check on version for zip64Mode. -->
        <condition property="zip64Mode">
            <antversion atleast="1.9.1"/>
        </condition>
        
    </target>

    <!-- [SP] 2015-02-27: Changed toc.ncx to nav.html-->
    <target name="sepub3.nav_html">
        <echo>Generate nav.html with BASE_DIR = ${dita.temp.dir}${file.separator}</echo>
        <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${dita.temp.dir}" force="true"
            in="${dita.temp.dir}${file.separator}${user.input.file}"
            out="${dita.temp.dir}${file.separator}nav.html"
            style="${dita.plugin.com.kpe.sepub3.dir}${file.separator}xsl${file.separator}map2nav_html.xsl">
            <param name="BASE_DIR" expression="${dita.temp.dir}${file.separator}"/>
        </xslt>
    </target>

    <target name="sepub3.content_opf">
        <echo>Generate content.opf file.</echo>

        <copy todir="${output.dir}${file.separator}css" includeemptydirs="yes">
            <fileset
                dir="${dita.plugin.com.kpe.sepub3.dir}${file.separator}resource${file.separator}css"
                includes="**${file.separator}*.*"/>
        </copy>

        <!-- Get the main.css from the kpe web site. -->
        <!--        <get description="Fetch the kpe main.css"
            src="http://www.kpenetworks.com/css/main.css" 
            dest="${output.dir}${file.separator}css${file.separator}kpe_main.css" 
            />
-->
        <!-- Get the kpe_style.css from the kpe_xhtml plugin. -->
        <copy
            file="${dita.plugin.com.kpe.sepub3.dir}${file.separator}resource${file.separator}css${file.separator}kpe_style.css"
            todir="${output.dir}${file.separator}css"/>
<!--        added Advanced Des CSS -->
        <copy
            file="${dita.plugin.com.kpe.sepub3.dir}${file.separator}resource${file.separator}css${file.separator}CSS_AD.css"
            todir="${output.dir}${file.separator}css"/>
        <!-- Copy resource images from kpe.xhtml plugin. -->
        <copy todir="${output.dir}${file.separator}images" includeemptydirs="yes">
            <fileset
                dir="${dita.plugin.com.kpe.xhtml.dir}${file.separator}resource${file.separator}images"
                includes="**${file.separator}*.*"/>
        </copy>

        <fileset dir="${output.dir}${file.separator}" id="ancillary_files">
            <include name="**${file.separator}digital${file.separator}*.*"/>
            <include name="**${file.separator}images${file.separator}*.*"/>
            <exclude name="**${file.separator}images${file.separator}*.svg"/>
            <include name="**${file.separator}Graphics${file.separator}*.*"/>
            <exclude name="**${file.separator}Graphics${file.separator}*.svg"/>
            <include name="**${file.separator}css${file.separator}*.css"/>
            <include name="**${file.separator}fonts${file.separator}*.*"/>
        </fileset>

        <pathconvert pathsep="," property="ancillary_list" refid="ancillary_files">
            <map from="${output.dir}${file.separator}" to=""/>
        </pathconvert>

        <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${dita.temp.dir}" force="true"
            in="${dita.temp.dir}${file.separator}${user.input.file}"
            out="${dita.temp.dir}${file.separator}content.opf"
            style="${dita.plugin.com.kpe.sepub3.dir}${file.separator}xsl${file.separator}map2content_opf.xsl">
            <param name="BASE_DIR" expression="${dita.temp.dir}${file.separator}"/>
            <param name="ancillary_list" expression="${ancillary_list}"/>
            <param name="out_dir" expression="${output.dir}${file.separator}"/>
            <param name="file.separator" expression="${file.separator}"/>
        </xslt>
    </target>

    <!-- Create the index file. -->
    <target name="sepub3.index" unless="noMap" description="Build Index file">
        <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${output.dir}" force="true"
            in="${dita.temp.dir}${file.separator}${user.input.file}"
            out="${output.dir}${file.separator}rawindex${xml.ext}"
            style="${dita.plugin.com.kpe.sepub3.dir}${file.separator}xsl${file.separator}map2spsindex.xsl"> </xslt>

        <xslt processor="trax" basedir="${output.dir}" destdir="${output.dir}" force="true"
            in="${output.dir}${file.separator}rawindex${xml.ext}"
            out="${output.dir}${file.separator}groupindex${xml.ext}"
            style="${dita.plugin.com.kpe.sepub3.dir}${file.separator}xsl${file.separator}groupindex.xsl"> </xslt>
        <xslt processor="trax" basedir="${output.dir}" destdir="${output.dir}" force="true"
            in="${output.dir}${file.separator}groupindex${xml.ext}"
            out="${output.dir}${file.separator}index.html"
            style="${dita.plugin.com.kpe.sepub3.dir}${file.separator}xsl${file.separator}xslhtml${file.separator}index2html.xsl">
            <param name="SOURCEFILE" expression="${args.input}"/>
            <param name="file.separator" expression="${file.separator}"/>

        </xslt>
    </target>

    <!--To generate&copy inner files-->
    <!--requirement 1,2-->
    <target name="sepub3.dita.inner.topics.xhtml" unless="noTopic" if="inner.transform"
        depends="dita.xhtml.init" description="Build XHTML output from inner dita topics">
        <condition property="args.xsl" value="${dita.plugin.org.dita.xhtml.dir}/xsl/dita2xhtml.xsl">
            <not>
                <isset property="args.xsl"/>
            </not>
        </condition>
        <xslt basedir="${dita.temp.dir}" destdir="${output.dir}"
            includesfile="${dita.temp.dir}${file.separator}${chunkedtopicfile}"
            reloadstylesheet="${dita.xhtml.reloadstylesheet}" classpathref="dost.class.path"
            extension="${out.ext}" style="${args.xsl}" filenameparameter="FILENAME"
            filedirparameter="FILEDIR">
            <excludesfile name="${dita.temp.dir}${file.separator}${resourceonlyfile}"
                if="resourceonlyfile"/>
<!--            <includesfile name="${dita.temp.dir}${file.separator}${chunkedtopicfile}"
                if="chunkedtopicfile"/>-->
            <param name="TRANSTYPE" expression="${transtype}"/>
            <param name="DITAEXT" expression="${dita.ext}" if="dita.ext"/>
            <param name="FILTERFILE" expression="${dita.input.valfile.url}" if="dita.input.valfile"/>
            <param name="CSS" expression="${args.css.file}" if="args.css.file"/>
            <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"/>
            <param name="HDF" expression="${args.hdf}" if="args.hdf"/>
            <param name="HDR" expression="${args.hdr}" if="args.hdr"/>
            <param name="FTR" expression="${args.ftr}" if="args.ftr"/>
            <param name="DRAFT" expression="${args.draft}" if="args.draft"/>
            <param name="ARTLBL" expression="${args.artlbl}" if="args.artlbl"/>
            <param name="GENERATE-TASK-LABELS" expression="${args.gen.task.lbl}"
                if="args.gen.task.lbl"/>
            <param name="PRESERVE-DITA-CLASS" expression="${args.xhtml.classattr}"
                if="args.xhtml.classattr"/>
            <param name="NOPARENTLINK" expression="${args.hide.parent.link}"
                if="args.hide.parent.link"/>
            <param name="include.rellinks" expression="${include.rellinks}"/>
            <param name="BREADCRUMBS" expression="${args.breadcrumbs}" if="args.breadcrumbs"/>
            <param name="INDEXSHOW" expression="${args.indexshow}" if="args.indexshow"/>
            <param name="genDefMeta" expression="${args.gen.default.meta}"
                if="args.gen.default.meta"/>
            <param name="OUTEXT" expression="${out.ext}" if="out.ext"/>
            <param name="BASEDIR" expression="${basedir}"/>
            <param name="OUTPUTDIR" expression="${output.dir}"/>
            <param name="DBG" expression="${args.debug}" if="args.debug"/>
            <!--
   New param to pass DITA map file name to HTML transforms.
   ${output.dir} must include a full path. 
 -->

            <param name="INPUT" expression="${args.input}"/>

            <param name="MAPFILE" expression="${dita.temp.dir}${file.separator}${user.input.file}"/>
<!--            psb added this-->
            <!--<param name="EPUBOUTPUT_TYPE" expression="${KPEepub.output.type}"/>-->

            <param name="TOPIC_LIST" expression="${dita.temp.dir}${file.separator}topic_list.xml"/>

            <!-- [SP] for PDF and EPUB links -->
            <!--<param name="TOPICS_SUBDIR" expression="${user.input.file}"/>-->


            <param name="MAPFILE_FILE" expression="${user.input.file}"/>

            <param name="OUTPUT_DIR" expression="${output.dir}"/>

            <param name="DEBUG" expression="${args.debug}"/>
            <!--  <param name="force.pngs" expression="${force.pngs}"/>-->

            <param name="file.separator" expression="${file.separator}"/>
            <!--
   New param to pass DITA map file name to HTML transforms.
   ${output.dir} must include a full path. 
   
   [SP] add MAPFILE param SSO
 -->
            <!--  <param name="CSS" expression="local.css"/>-->

            <param name="MAPFILE" expression="${dita.temp.dir}${file.separator}${user.input.file}"/>
            
            <param name="BASE_DIR" expression="${dita.temp.dir}${file.separator}"/>

          
            <!--New,To generate&copy all dita files in the inputmap.dir,not all files in dita.temp.dir -->
            <mapper type="regexp"
                from="^(${tempdirToinputmapdir.relative.value})(.*?)(\.(xml|dita))$$"
                to="\2${out.ext}"/>
            <xmlcatalog refid="dita.catalog"/>
        </xslt>
    </target>


    <target name="sepub3.make_dups">
        <!-- Create duplicate topics for all re-used topics in the map. -->
        <!--        <!-\- Build a list of the required duplicates. -\->
        <xslt processor="trax" 
            basedir="${dita.temp.dir}" 
            destdir="${dita.temp.dir}" 
            force="true"
            in="${dita.temp.dir}${file.separator}${user.input.file}"
            out="${dita.temp.dir}${file.separator}topic_dups.ditamap"
            style="${dita.plugin.com.kpe.sepub3.dir}${file.separator}xsl${file.separator}map2dup_list.xsl">
            <param name="BASE_DIR" expression="${dita.temp.dir}${file.separator}"/>
            <param name="out_dir" expression="${output.dir}${file.separator}"/>
            <param name="file.separator" expression="${file.separator}"/>
        </xslt>
        
        <!-\- Use the list to copy the HTML files. -\->
        <xslt processor="trax" 
            basedir="${dita.temp.dir}" 
            destdir="${dita.temp.dir}" 
            force="true"
            in="${dita.temp.dir}${file.separator}topic_dups.ditamap"
            out="${dita.temp.dir}${file.separator}dups_copied.list"
            style="${dita.plugin.com.kpe.sepub3.dir}${file.separator}xsl${file.separator}copy_dup_list.xsl">
            <param name="BASE_DIR" expression="${dita.temp.dir}${file.separator}"/>
            <param name="out_dir" expression="${output.dir}${file.separator}"/>
            <param name="file.separator" expression="${file.separator}"/>
        </xslt>
        
-->
    </target>

    <target name="sepub3.make_package">
        <delete failonerror="false">
            <fileset dir="${output.dir}" includes="**/*.svg"/>
            <fileset dir="${output.dir}" includes="**/*.eps"/>
        </delete>
        <move todir="${output.dir}${file.separator}topics${file.separator}">
            <fileset dir="${output.dir}">
                <include name="**/*.png"/>
                <include name="**/*.jpg"/>
            </fileset>
        </move>
        <move todir="${output.dir}${file.separator}topics${file.separator}" encoding="UTF-8">
            <fileset dir="${output.dir}">
                <exclude name="*.list"/>
                <exclude name="*.properties"/>
                <exclude name="*.xml"/>
                <exclude name="**/*.png"/>
                <exclude name="**/*.jpg"/>
            </fileset>
            <filterchain>
                <tokenfilter>
                    <replacestring from='PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"' to=''/>
<!--                    <replacestring from="-//W3C//DTD XHTML 1.0 Transitional//EN"
                        to="-//W3C//DTD XHTML 1.1//EN"/>
                    <replacestring from="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"
                        to="http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"/>-->
                    <replacestring from="&lt;html&gt;"
                        to='&lt;html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"&gt;'/>
                </tokenfilter>
            </filterchain>
        </move>
        
        <!-- Similar fixups on nav.html -->
        <echo>Fixup on nav.html. </echo>
        <replace file="${dita.temp.dir}${file.separator}nav.html" 
            encoding="utf-8"
            token='&lt;html&gt;'
            value='&lt;html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"&gt;' summary="yes"/>
        

        <move todir="${output.dir}${file.separator}topics${file.separator}">
            <fileset dir="${output.dir}">
                <include name="*.png"/>
                <include name="*.jpg"/>
            </fileset>
        </move>

        <!-- Ensure the old (empty) topics folder is gone. -->
        <delete failonerror="false" includeemptydirs="true">
            <fileset dir="${output.dir}/topics/topics">
                <include name="**/*"/>
            </fileset>
        </delete>
        <!-- then really make sure it's gone. -->
        <delete failonerror="false" includeemptydirs="true" dir="${output.dir}/topics/topics"/>
        <!-- delete the print folder. -->
      <!--  <delete failonerror="false" includeemptydirs="true">
            <fileset dir="${output.dir}/topics">
                <include name="**/print"/>
            </fileset>
        </delete>-->
<!--  PSB EDIT  -->
        <!-- Get rid of the common*.css files. -->
        <delete failonerror="false">
            <fileset dir="${output.dir}/topics">
                <include name="*.css"/>
            </fileset>
        </delete> 
        

        <copy file="${dita.temp.dir}${file.separator}nav.html" todir="${output.dir}"/>
        <copy file="${dita.temp.dir}${file.separator}content.opf" todir="${output.dir}"/>
        <!--        <copy
            file="${dita.plugin.com.kpe.sepub3.dir}${file.separator}resource${file.separator}mimetype"
            todir="${output.dir}"/>-->
        <copy todir="${output.dir}${file.separator}META-INF${file.separator}" includeemptydirs="yes">
            <fileset
                dir="${dita.plugin.com.kpe.sepub3.dir}${file.separator}resource${file.separator}META-INF"
            />
        </copy>
        <basename property="epub.filename" file="${args.input}" suffix=".ditamap"/>
        <zip destfile="${output.dir}${file.separator}${epub.filename}.zip" basedir="${output.dir}"
            excludes="*.epub *.list *.properties index.html *.xml mimetype"/>
        <!-- [SP] 13-Mar-15 sfb: Copy pre-zipped mimetype because of Ant zip issues. -->
        <copy
            file="${dita.plugin.com.kpe.sepub3.dir}${file.separator}resource${file.separator}mimetype.zip"
            todir="${output.dir}"/>
        
        <!-- [SP] 13-Mar-15 sfb: Workaround: Don't worry about zipping mimetype because, for now, it's pre-zipped. -->
<!--        <antcall target="epub.zipmime"/>-->
        
        <zip destfile="${output.dir}${file.separator}${epub.filename}.epub" update="true"
            keepcompression="true">
            <zipfileset src="${output.dir}${file.separator}mimetype.zip"/>
            <zipfileset src="${output.dir}${file.separator}${epub.filename}.zip"/>
        </zip>
    </target>
    
    <!-- [SP] 2015-03-12: Added zip64Mode to avoid "Mimetype entry must not have..." error. -->
    <target name="epub.zipmime" depends="epub.zipmime.64,epub.zipmime.not64"/>
    <target name="epub.zipmime.64" if="${zip64Mode}">
        <zip destfile="${output.dir}${file.separator}mimetype.zip" basedir="${output.dir}"
            includes="mimetype" compress="false" zip64Mode="never"/>
    </target>
    <target name="epub.zipmime.not64" unless="${zip64Mode}">
        <echo>WARNING: The EPUB3 produced by this version of Ant (${antversion}) may not validate; upgrade to Ant 1.9.1 at a minimum.</echo>
        <zip destfile="${output.dir}${file.separator}mimetype.zip" basedir="${output.dir}"
            includes="mimetype" compress="false"/>
    </target>
    

    <target name="copy.pngs" if="${force.pngs}">
        <echo>Copying PNG "parallel" files. </echo>
        <!-- Create a new list that lists the SVG files. -->
        <copy file="${dita.temp.dir}${file.separator}image.list"
            tofile="${dita.temp.dir}${file.separator}png.list"
            description="Create a list of SVG images by copying and filtering the image list.">
            <filterchain>
                <tokenfilter>
                    <replaceregex pattern="\.svg" replace=".png" flags="ig"/>
                    <!--                     <replaceregex pattern="\.png" replace=".svg" flags="ig"/>-->
                </tokenfilter>
            </filterchain>
        </copy>

        <!-- Copy the .png images to the output folder.
             The image list includes the folder details.
        -->
        <copy todir="${output.dir}" overwrite="true" failonerror="false"
            description="The standard OT only copies
            image files that are referenced in the source DITA files. However, we want to provide PNG images.">
            <fileset dir="${user.input.dir}"
                includesfile="${dita.temp.dir}${file.separator}png.list"/>
        </copy>

    </target>


    <target name="sepub3.cleanup">
        <!--<delete includeemptydirs="yes">
            <fileset dir="${output.dir}">
                <include name="**/*"/>                
                <exclude name="*.epub"/>                
            </fileset>
        </delete>-->
    </target>

</project>
